{"version":3,"file":"exports.js","sources":["../../../src/metrics/exports.ts"],"sourcesContent":["import type {\n  Client,\n  MeasurementUnit,\n  MetricsAggregator as MetricsAggregatorInterface,\n  Primitive,\n} from '@sentry/types';\nimport { getGlobalSingleton, logger } from '@sentry/utils';\nimport { getClient } from '../currentScopes';\nimport { DEBUG_BUILD } from '../debug-build';\nimport { getActiveSpan, getRootSpan, spanToJSON } from '../utils/spanUtils';\nimport { COUNTER_METRIC_TYPE, DISTRIBUTION_METRIC_TYPE, GAUGE_METRIC_TYPE, SET_METRIC_TYPE } from './constants';\nimport type { MetricType } from './types';\n\nexport interface MetricData {\n  unit?: MeasurementUnit;\n  tags?: Record<string, Primitive>;\n  timestamp?: number;\n  client?: Client;\n}\n\ntype MetricsAggregatorConstructor = {\n  new (client: Client): MetricsAggregatorInterface;\n};\n\n/**\n * Gets the metrics aggregator for a given client.\n * @param client The client for which to get the metrics aggregator.\n * @param Aggregator Optional metrics aggregator class to use to create an aggregator if one does not exist.\n */\nfunction getMetricsAggregatorForClient(\n  client: Client,\n  Aggregator: MetricsAggregatorConstructor,\n): MetricsAggregatorInterface {\n  const globalMetricsAggregators = getGlobalSingleton<WeakMap<Client, MetricsAggregatorInterface>>(\n    'globalMetricsAggregators',\n    () => new WeakMap(),\n  );\n\n  const aggregator = globalMetricsAggregators.get(client);\n  if (aggregator) {\n    return aggregator;\n  }\n\n  const newAggregator = new Aggregator(client);\n  client.on('flush', () => newAggregator.flush());\n  client.on('close', () => newAggregator.close());\n  globalMetricsAggregators.set(client, newAggregator);\n\n  return newAggregator;\n}\n\nfunction addToMetricsAggregator(\n  Aggregator: MetricsAggregatorConstructor,\n  metricType: MetricType,\n  name: string,\n  value: number | string,\n  data: MetricData | undefined = {},\n): void {\n  const client = data.client || getClient<Client>();\n\n  if (!client) {\n    return;\n  }\n\n  const span = getActiveSpan();\n  const rootSpan = span ? getRootSpan(span) : undefined;\n\n  const { unit, tags, timestamp } = data;\n  const { release, environment } = client.getOptions();\n  const metricTags: Record<string, string> = {};\n  if (release) {\n    metricTags.release = release;\n  }\n  if (environment) {\n    metricTags.environment = environment;\n  }\n  if (rootSpan) {\n    metricTags.transaction = spanToJSON(rootSpan).description || '';\n  }\n\n  DEBUG_BUILD && logger.log(`Adding value of ${value} to ${metricType} metric ${name}`);\n\n  const aggregator = getMetricsAggregatorForClient(client, Aggregator);\n  aggregator.add(metricType, name, value, unit, { ...metricTags, ...tags }, timestamp);\n}\n\n/**\n * Adds a value to a counter metric\n *\n * @experimental This API is experimental and might have breaking changes in the future.\n */\nfunction increment(aggregator: MetricsAggregatorConstructor, name: string, value: number = 1, data?: MetricData): void {\n  addToMetricsAggregator(aggregator, COUNTER_METRIC_TYPE, name, value, data);\n}\n\n/**\n * Adds a value to a distribution metric\n *\n * @experimental This API is experimental and might have breaking changes in the future.\n */\nfunction distribution(aggregator: MetricsAggregatorConstructor, name: string, value: number, data?: MetricData): void {\n  addToMetricsAggregator(aggregator, DISTRIBUTION_METRIC_TYPE, name, value, data);\n}\n\n/**\n * Adds a value to a set metric. Value must be a string or integer.\n *\n * @experimental This API is experimental and might have breaking changes in the future.\n */\nfunction set(aggregator: MetricsAggregatorConstructor, name: string, value: number | string, data?: MetricData): void {\n  addToMetricsAggregator(aggregator, SET_METRIC_TYPE, name, value, data);\n}\n\n/**\n * Adds a value to a gauge metric\n *\n * @experimental This API is experimental and might have breaking changes in the future.\n */\nfunction gauge(aggregator: MetricsAggregatorConstructor, name: string, value: number, data?: MetricData): void {\n  addToMetricsAggregator(aggregator, GAUGE_METRIC_TYPE, name, value, data);\n}\n\nexport const metrics = {\n  increment,\n  distribution,\n  set,\n  gauge,\n  /**\n   * @ignore This is for internal use only.\n   */\n  getMetricsAggregatorForClient,\n};\n"],"names":[],"mappings":"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"}